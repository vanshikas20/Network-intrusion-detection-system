<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Network Intrusion Detection System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 3px solid #667eea;
        }
        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            border: none;
            background: transparent;
            font-size: 16px;
        }
        .tab:hover { background: #e0e0e0; }
        .tab.active { background: white; color: #667eea; }
        .content { padding: 40px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .form-group { margin-bottom: 20px; }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #667eea; }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            display: inline-block;
            margin-top: 10px;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .result-box {
            margin-top: 30px;
            padding: 25px;
            border-radius: 10px;
            display: none;
        }
        .result-box.show { display: block; animation: slideIn 0.5s; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .result-attack { background: #ffebee; border-left: 5px solid #f44336; }
        .result-normal { background: #e8f5e9; border-left: 5px solid #4caf50; }
        .result-title { font-size: 24px; font-weight: bold; margin-bottom: 15px; }
        .result-details { line-height: 1.8; }

        /* MODE INDICATORS */
        .mode-banner {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 10px;
            font-weight: bold;
            text-align: center;
            display: none;
        }
        .mode-banner.show { display: block; animation: slideIn 0.5s; }
        .mode-real {
            background: #e8f5e9;
            border: 2px solid #4caf50;
            color: #2e7d32;
        }
        .mode-error {
            background: #ffebee;
            border: 2px solid #f44336;
            color: #c62828;
        }
        .mode-starting {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #f57c00;
        }

        /* DASHBOARD STYLES */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .stat-card h3 { font-size: 14px; opacity: 0.9; margin-bottom: 10px; }
        .stat-card .value { font-size: 36px; font-weight: bold; }
        .stat-card.green { background: linear-gradient(135deg, #4caf50, #45a049); }
        .stat-card.red { background: linear-gradient(135deg, #f44336, #e53935); }
        .stat-card.blue { background: linear-gradient(135deg, #2196f3, #1976d2); }

        .status-indicator {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-active { background: #4caf50; animation: pulse 2s infinite; }
        .status-inactive { background: #9e9e9e; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .alert-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .alert-box.high { background: #ffebee; border-color: #f44336; }
        .alert-box.medium { background: #fff3cd; border-color: #ff9800; }
        .alert-box.low { background: #e3f2fd; border-color: #1976d2; }

        .website-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .website-item {
            background: #f5f5f5;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .website-item.safe { border-left: 4px solid #4caf50; }
        .website-item.suspicious { border-left: 4px solid #f44336; }

        .badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        .badge.safe { background: #4caf50; color: white; }
        .badge.warning { background: #ff9800; color: white; }
        .badge.danger { background: #f44336; color: white; }
        .badge.critical { background: #d32f2f; color: white; }
        .badge.high { background: #f57c00; color: white; }
        .badge.medium { background: #fbc02d; color: white; color: #000; }
        .badge.low { background: #1976d2; color: white; }

        .live-feed {
            max-height: 500px;
            overflow-y: auto;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
        }
        .packet-item {
            background: white;
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            border-left: 4px solid #667eea;
            font-family: monospace;
            font-size: 13px;
        }
        .packet-item.attack { border-left-color: #f44336; background: #ffebee; }

        .error-box {
            background: #ffebee;
            border: 2px solid #f44336;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .error-box h3 {
            color: #c62828;
            margin-bottom: 10px;
        }
        .error-box ul {
            margin-left: 20px;
            margin-top: 10px;
        }
        .error-box li {
            margin: 5px 0;
        }

        /* spinner */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* table responsiveness */
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px; border-bottom: 1px solid #eee; text-align: left; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏è Network Intrusion Detection System</h1>
            <p>AI-Powered Network Security Monitoring with Real-time Analysis</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard', this)">üìä Dashboard</button>
            <button class="tab" onclick="switchTab('manual', this)">üìù Manual Input</button>
            <button class="tab" onclick="switchTab('csv', this)">üìÅ CSV Upload</button>
            <button class="tab" onclick="switchTab('live', this)">üî¥ Live Monitor</button>
        </div>

        <div class="content">
            <!-- DASHBOARD TAB -->
            <div id="dashboard" class="tab-content active">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Network Security Dashboard</h2>
                    <div>
                        <span id="dashStatus" class="status-indicator status-inactive"></span>
                        <span id="dashStatusText">Monitoring: Inactive</span>
                    </div>
                </div>

                <div id="dashboardModeBanner" class="mode-banner"></div>

                <div class="dashboard-grid">
                    <div class="stat-card blue">
                        <h3>TOTAL PACKETS</h3>
                        <div class="value" id="totalPackets">0</div>
                        <small>Analyzed in real-time</small>
                    </div>
                    <div class="stat-card green">
                        <h3>NORMAL</h3>
                        <div class="value" id="normalCount">0</div>
                        <small>Safe connections</small>
                    </div>
                    <div class="stat-card red">
                        <h3>ATTACKS DETECTED</h3>
                        <div class="value" id="attackCount">0</div>
                        <small>Threats blocked</small>
                    </div>
                    <div class="stat-card">
                        <h3>SAFETY SCORE</h3>
                        <div class="value" id="safetyScore">100%</div>
                        <small id="networkStatus">Network Protected</small>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                    <div>
                        <h3 style="margin-bottom: 15px;">üö® Recent Security Alerts</h3>
                        <div id="alertsList" style="max-height: 300px; overflow-y: auto;">
                            <p style="text-align: center; color: #999; padding: 20px;">No alerts yet</p>
                        </div>
                    </div>

                    <div>
                        <h3 style="margin-bottom: 15px;">üåê Monitored Websites</h3>
                        <div id="websitesList" class="website-list">
                            <p style="text-align: center; color: #999; padding: 20px;">Start monitoring to see websites</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MANUAL INPUT TAB -->
            <div id="manual" class="tab-content">
                <h2>Single Connection Analysis</h2>
                <p style="margin-bottom: 20px; color: #666;">Enter network connection details for instant analysis</p>

                <form id="manualForm">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label>Duration (seconds)</label>
                            <input type="number" id="duration" value="0" min="0">
                        </div>
                        <div class="form-group">
                            <label>Protocol Type</label>
                            <select id="protocol_type">
                                <option value="tcp">TCP</option>
                                <option value="udp">UDP</option>
                                <option value="icmp">ICMP</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Service</label>
                            <select id="service">
                                <option value="http">HTTP</option>
                                <option value="smtp">SMTP</option>
                                <option value="ftp">FTP</option>
                                <option value="ssh">SSH</option>
                                <option value="domain">DNS</option>
                                <option value="private">Private</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Connection Flag</label>
                            <select id="flag">
                                <option value="SF">SF (Normal)</option>
                                <option value="S0">S0 (SYN)</option>
                                <option value="REJ">REJ (Rejected)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Source Bytes</label>
                            <input type="number" id="src_bytes" value="200" min="0">
                        </div>
                        <div class="form-group">
                            <label>Destination Bytes</label>
                            <input type="number" id="dst_bytes" value="1500" min="0">
                        </div>
                        <div class="form-group">
                            <label>Connection Count</label>
                            <input type="number" id="count" value="10" min="0">
                        </div>
                        <div class="form-group">
                            <label>Service Count</label>
                            <input type="number" id="srv_count" value="5" min="0">
                        </div>
                    </div>
                    <button type="submit" class="btn">üîç Analyze Connection</button>
                </form>

                <div id="manualResult" class="result-box"></div>
            </div>

            <!-- CSV UPLOAD TAB -->
            <div id="csv" class="tab-content">
                <h2>Batch Analysis from CSV</h2>
                <p style="margin-bottom: 20px; color: #666;">Upload CSV file with network connection data</p>

                <div class="file-upload" onclick="document.getElementById('csvFile').click()" style="border: 3px dashed #667eea; padding: 40px; text-align: center; border-radius: 10px; cursor: pointer;">
                    <div style="font-size: 48px; margin-bottom: 10px;">üìÅ</div>
                    <p style="font-size: 18px; font-weight: bold;">Click to upload CSV file</p>
                    <p style="color: #666; margin-top: 10px;">Required: duration, protocol_type, service, flag, src_bytes, dst_bytes, count, srv_count</p>
                    <input type="file" id="csvFile" accept=".csv" style="display: none;">
                </div>

                <div id="csvResult" class="result-box"></div>
            </div>

            <!-- LIVE MONITORING TAB -->
            <div id="live" class="tab-content">
                <h2>Real-Time Network Monitoring</h2>
                <p style="margin-bottom: 20px; color: #666;">Live packet capture and analysis</p>

                <div id="liveModeBanner" class="mode-banner"></div>

                <div style="background: #f5f5f5; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span id="liveStatus" class="status-indicator status-inactive"></span>
                            <span id="liveStatusText" style="font-weight: bold;">Status: Idle</span>
                            <span id="liveUptime" style="margin-left: 20px; color: #666;"></span>
                        </div>
                        <div>
                            <button id="startBtn" class="btn" onclick="startMonitoring()">‚ñ∂Ô∏è Start</button>
                            <button id="stopBtn" class="btn" onclick="stopMonitoring()" style="display: none; background: #f44336;">‚èπÔ∏è Stop</button>
                        </div>
                    </div>
                </div>

                <div id="errorContainer"></div>

                <div class="live-feed" id="liveFeed">
                    <p style="text-align: center; color: #999;">Click "Start" to begin monitoring network traffic...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let monitoringInterval;
        let dashboardInterval;

        function switchTab(tabName, element) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            if (element) element.classList.add('active');
        }

        // MANUAL FORM WITH ALERT GENERATION
        document.getElementById('manualForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                duration: parseInt(document.getElementById('duration').value),
                protocol_type: document.getElementById('protocol_type').value,
                service: document.getElementById('service').value,
                flag: document.getElementById('flag').value,
                src_bytes: parseInt(document.getElementById('src_bytes').value),
                dst_bytes: parseInt(document.getElementById('dst_bytes').value),
                count: parseInt(document.getElementById('count').value),
                srv_count: parseInt(document.getElementById('srv_count').value)
            };

            const resultBox = document.getElementById('manualResult');
            resultBox.innerHTML = '<div class="loading" style="text-align: center; padding: 20px;"><div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto;"></div><p>Analyzing...</p></div>';
            resultBox.classList.add('show');

            try {
                const response = await fetch('/predict', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (result.error) throw new Error(result.error);

                const isAttack = result.prediction === 'Attack';
                resultBox.className = `result-box show ${isAttack ? 'result-attack' : 'result-normal'}`;

                let alertHTML = '';
                if (result.alert_details) {
                    const alert = result.alert_details;
                    const severityClass = alert.severity ? alert.severity.toLowerCase() : 'medium';

                    alertHTML = `
                        <div style="margin-top: 20px; padding: 20px; background: #fff3cd; border-left: 5px solid #f44336; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="margin: 0; color: #c62828;">üö® Security Alert</h3>
                                <span class="badge ${severityClass}">${alert.severity || 'MEDIUM'}</span>
                            </div>

                            <div style="margin-bottom: 15px;">
                                <p><strong>Attack Type:</strong> ${alert.attack_type}</p>
                                <p><strong>Protocol:</strong> ${alert.protocol} | <strong>Service:</strong> ${alert.service} | <strong>Flag:</strong> ${alert.flag}</p>
                                <p><strong>Data Transfer:</strong> ${alert.src_bytes} bytes sent, ${alert.dst_bytes} bytes received</p>
                            </div>

                            ${alert.recommendations && alert.recommendations.length > 0 ? `
                                <div style="background: white; padding: 15px; border-radius: 5px;">
                                    <h4 style="margin-top: 0; color: #d32f2f;">‚ö†Ô∏è Recommendations:</h4>
                                    <ul style="margin: 0; padding-left: 20px;">
                                        ${alert.recommendations.map(rec => `<li style="margin: 8px 0;">${rec}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }

                resultBox.innerHTML = `
                    <div class="result-title">${isAttack ? '‚ö†Ô∏è ATTACK DETECTED' : '‚úÖ NORMAL CONNECTION'}</div>
                    <div class="result-details">
                        <p><strong>Prediction:</strong> ${result.prediction}</p>
                        <p><strong>Attack Probability:</strong> ${(result.attack_probability * 100).toFixed(2)}%</p>
                        <p><strong>Confidence:</strong> ${(result.confidence * 100).toFixed(2)}%</p>
                    </div>
                    ${alertHTML}
                `;
            } catch (error) {
                resultBox.className = 'result-box show result-attack';
                resultBox.innerHTML = `<div class="result-title">‚ùå Error</div><p>${error.message}</p>`;
            }
        });

        // CSV UPLOAD WITH COMPREHENSIVE REPORTING
        document.getElementById('csvFile').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            const resultBox = document.getElementById('csvResult');
            resultBox.innerHTML = '<div class="loading" style="text-align: center; padding: 20px;"><div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto;"></div><p>Processing CSV...</p></div>';
            resultBox.classList.add('show');

            try {
                const response = await fetch('/predict_csv', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.error) {
                    resultBox.className = 'result-box show result-attack';
                    resultBox.innerHTML = `<div class="result-title">‚ùå Error</div><p>${result.error}</p>`;
                    return;
                }

                const attackPercentage = result.attack_percentage || 0;
                const isHighRisk = attackPercentage > 50;

                resultBox.className = `result-box show ${isHighRisk ? 'result-attack' : 'result-normal'}`;

                // Generate protocol breakdown chart
                let protocolHTML = '';
                if (result.protocol_breakdown && Object.keys(result.protocol_breakdown).length > 0) {
                    protocolHTML = '<div style="margin-top: 15px;"><strong>Attack by Protocol:</strong><ul style="margin: 5px 0; padding-left: 20px;">';
                    for (const [protocol, count] of Object.entries(result.protocol_breakdown)) {
                        protocolHTML += `<li>${protocol.toUpperCase()}: ${count} attacks</li>`;
                    }
                    protocolHTML += '</ul></div>';
                }

                // Generate service breakdown
                let serviceHTML = '';
                if (result.service_breakdown && Object.keys(result.service_breakdown).length > 0) {
                    serviceHTML = '<div style="margin-top: 15px;"><strong>Attack by Service:</strong><ul style="margin: 5px 0; padding-left: 20px;">';
                    for (const [service, count] of Object.entries(result.service_breakdown)) {
                        serviceHTML += `<li>${service}: ${count} attacks</li>`;
                    }
                    serviceHTML += '</ul></div>';
                }

                // Severity badges
                const severityHTML = `
                    <div style="margin-top: 15px;">
                        <strong>Threat Severity:</strong>
                        <div style="display: flex; gap: 10px; margin-top: 8px; flex-wrap: wrap;">
                            <span class="badge critical">CRITICAL: ${result.severity_counts.critical}</span>
                            <span class="badge danger">HIGH: ${result.severity_counts.high}</span>
                            <span class="badge medium">MEDIUM: ${result.severity_counts.medium}</span>
                            <span class="badge low">LOW: ${result.severity_counts.low}</span>
                        </div>
                    </div>
                `;

                // Top threats table
                let threatsHTML = '';
                if (result.top_threats && result.top_threats.length > 0) {
                    threatsHTML = `
                        <div style="margin-top: 20px; background: white; padding: 15px; border-radius: 8px; border: 2px solid #f44336;">
                            <h3 style="margin-top: 0; color: #c62828;">üö® Top 10 Most Dangerous Connections</h3>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                    <thead>
                                        <tr style="background: #f5f5f5; text-align: left;">
                                            <th style="padding: 8px; border-bottom: 2px solid #ddd;">Row</th>
                                            <th style="padding: 8px; border-bottom: 2px solid #ddd;">Protocol</th>
                                            <th style="padding: 8px; border-bottom: 2px solid #ddd;">Service</th>
                                            <th style="padding: 8px; border-bottom: 2px solid #ddd;">Flag</th>
                                            <th style="padding: 8px; border-bottom: 2px solid #ddd;">Probability</th>
                                            <th style="padding: 8px; border-bottom: 2px solid #ddd;">Severity</th>
                                            <th style="padding: 8px; border-bottom: 2px solid #ddd;">Data (bytes)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${result.top_threats.map(threat => `
                                            <tr style="border-bottom: 1px solid #eee;">
                                                <td style="padding: 8px;">#${threat.row}</td>
                                                <td style="padding: 8px;">${threat.protocol.toUpperCase()}</td>
                                                <td style="padding: 8px;">${threat.service}</td>
                                                <td style="padding: 8px;">${threat.flag}</td>
                                                <td style="padding: 8px; font-weight: bold; color: #f44336;">${(threat.probability * 100).toFixed(1)}%</td>
                                                <td style="padding: 8px;"><span class="badge ${threat.severity.toLowerCase()}">${threat.severity}</span></td>
                                                <td style="padding: 8px; font-family: monospace;">${threat.src_bytes} ‚Üí ${threat.dst_bytes}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }

                resultBox.innerHTML = `
                    <div class="result-title">üìä Batch Analysis Complete</div>
                    <div class="result-details">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 32px; font-weight: bold; color: #1976d2;">${result.total_records}</div>
                                <div style="color: #666; margin-top: 5px;">Total Records</div>
                            </div>
                            <div style="background: #ffebee; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 32px; font-weight: bold; color: #f44336;">${result.attacks_detected}</div>
                                <div style="color: #666; margin-top: 5px;">Attacks Detected</div>
                            </div>
                            <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 32px; font-weight: bold; color: #2e7d32;">${(100 - result.attack_percentage).toFixed(1)}%</div>
                                <div style="color: #666; margin-top: 5px;">Healthy Connections</div>
                            </div>
                            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 32px; font-weight: bold; color: #f57c00;">${result.severity_counts.critical + result.severity_counts.high}</div>
                                <div style="color: #666; margin-top: 5px;">High & Critical</div>
                            </div>
                        </div>

                        ${protocolHTML}
                        ${serviceHTML}
                        ${severityHTML}
                        ${threatsHTML}

                        <div style="margin-top: 20px; display:flex; gap:10px; flex-wrap:wrap;">
                            ${result.download_file ? `<a class="btn" href="/download/${result.download_file}">‚¨áÔ∏è Download Results</a>` : ''}
                            <button class="btn" onclick="switchTab('dashboard', document.querySelector('.tab'))">üè† Back to Dashboard</button>
                        </div>
                    </div>
                `;
            } catch (error) {
                resultBox.className = 'result-box show result-attack';
                resultBox.innerHTML = `<div class="result-title">‚ùå Error</div><p>${error.message}</p>`;
            }
        });

        /* ------------------ REAL-TIME MONITORING ------------------ */

        async function startMonitoring() {
            document.getElementById("liveModeBanner").classList.remove("show");
            document.getElementById("errorContainer").innerHTML = "";

            try {
                const response = await fetch("/start_monitoring", { method: "POST" });
                const result = await response.json();

                document.getElementById("liveStatus").classList.remove("status-inactive");
                document.getElementById("liveStatus").classList.add("status-active");
                document.getElementById("liveStatusText").innerText = "Status: Starting...";
                document.getElementById("startBtn").style.display = "none";
                document.getElementById("stopBtn").style.display = "inline-block";

                monitoringInterval = setInterval(updateLiveFeed, 1000);
                dashboardInterval = setInterval(loadDashboard, 2000);

                // Show banner
                const banner = document.getElementById("liveModeBanner");
                banner.innerText = "Live capture started (SCAPY). Run backend as Administrator.";
                banner.className = "mode-banner mode-starting show";
            } catch (err) {
                document.getElementById("errorContainer").innerHTML = `<div class="error-box"><h3>‚ùå Start Failed</h3><p>${err.message}</p></div>`;
            }
        }

        async function stopMonitoring() {
            try {
                await fetch("/stop_monitoring", { method: "POST" });
            } catch (e) {
                // ignore
            }

            clearInterval(monitoringInterval);
            clearInterval(dashboardInterval);

            document.getElementById("liveStatus").classList.remove("status-active");
            document.getElementById("liveStatus").classList.add("status-inactive");
            document.getElementById("liveStatusText").innerText = "Status: Idle";
            document.getElementById("startBtn").style.display = "inline-block";
            document.getElementById("stopBtn").style.display = "none";

            document.getElementById("liveFeed").innerHTML =
                '<p style="text-align:center;color:#999;">Stopped monitoring.</p>';

            const banner = document.getElementById("liveModeBanner");
            banner.innerText = "Live capture stopped.";
            banner.className = "mode-banner mode-real show";
        }

        /* ------------------ UPDATE LIVE PACKET FEED ------------------ */

        async function updateLiveFeed() {
            try {
                const res = await fetch("/get_live_data");
                const data = await res.json();

                const feed = document.getElementById("liveFeed");

                if (data.error_message) {
                    document.getElementById("errorContainer").innerHTML = `
                        <div class="error-box">
                            <h3>‚ùå Error</h3>
                            <p>${data.error_message}</p>
                        </div>`;
                } else {
                    document.getElementById("errorContainer").innerHTML = "";
                }

                if (!data.predictions || data.predictions.length === 0) {
                    feed.innerHTML =
                        '<p style="text-align:center;color:#999;">Waiting for packets...</p>';
                    return;
                }

                let html = "";
                data.predictions.forEach(p => {
                    html += `
                        <div class="packet-item ${p.prediction === "Attack" ? "attack" : ""}">
                            [${new Date(p.timestamp * 1000).toLocaleTimeString()}]  
                            <strong>${(p.protocol_type || '').toUpperCase()}</strong> |
                            ${p.src_ip} ‚Üí ${p.hostname} (${p.service})
                            <br>
                            Probability: ${(p.probability * 100).toFixed(1)}%
                        </div>`;
                });

                feed.innerHTML = html;
            } catch (err) {
                // silently fail, but show message once
                document.getElementById("errorContainer").innerHTML = `<div class="error-box"><h3>‚ùå Connection Error</h3><p>Could not fetch live data: ${err.message}</p></div>`;
            }
        }

        /* ------------------ DASHBOARD AUTO-REFRESH ------------------ */

        async function loadDashboard() {
            try {
                const res = await fetch("/get_dashboard");
                const d = await res.json();

                document.getElementById("totalPackets").innerText = d.total_packets || 0;
                document.getElementById("normalCount").innerText = d.normal_count || 0;
                document.getElementById("attackCount").innerText = d.attack_count || 0;
                document.getElementById("safetyScore").innerText = (d.safety_score !== undefined ? d.safety_score : 100) + "%";
                document.getElementById("networkStatus").innerText = d.status || "IDLE";

                // Monitoring indicator
                if (d.capture_mode === "real") {
                    document.getElementById("dashStatus").classList.add("status-active");
                    document.getElementById("dashStatusText").innerText = "Monitoring: Active";
                } else if (d.capture_mode === "starting") {
                    document.getElementById("dashStatus").classList.add("status-active");
                    document.getElementById("dashStatusText").innerText = "Monitoring: Starting";
                } else {
                    document.getElementById("dashStatus").classList.remove("status-active");
                    document.getElementById("dashStatusText").innerText = "Monitoring: Inactive";
                }

                /* ------------ WEBSITES LIST ------------ */
                let websiteHTML = "";
                if (!d.top_websites || d.top_websites.length === 0) {
                    websiteHTML =
                        '<p style="text-align:center;color:#999;">Start monitoring to see websites</p>';
                } else {
                    d.top_websites.forEach(w => {
                        websiteHTML += `
                            <div class="website-item ${w.status === "SAFE" ? "safe" : "suspicious"}">
                                <div>
                                    <strong>${w.hostname}</strong><br>
                                    <small>${w.ip} | ${w.service}</small>
                                </div>
                                <span class="badge ${w.status === "SAFE" ? "safe" : "danger"}">
                                    ${w.status}
                                </span>
                            </div>`;
                    });
                }
                document.getElementById("websitesList").innerHTML = websiteHTML;

                /* ------------ RECENT ALERTS ------------ */
                let alertHTML = "";
                if (!d.recent_alerts || d.recent_alerts.length === 0) {
                    alertHTML =
                        '<p style="text-align:center;color:#999;">No alerts yet</p>';
                } else {
                    d.recent_alerts.slice().reverse().forEach(a => {
                        const sev = (a.severity || 'MEDIUM').toLowerCase();
                        alertHTML += `
                            <div class="alert-box ${sev}">
                                <strong>${a.type}</strong>
                                <span class="badge ${sev}" style="margin-left:10px;">${a.severity}</span>
                                <br>
                                ${a.details}
                            </div>`;
                    });
                }
                document.getElementById("alertsList").innerHTML = alertHTML;

            } catch (err) {
                document.getElementById("errorContainer").innerHTML = `<div class="error-box"><h3>‚ùå Dashboard Error</h3><p>${err.message}</p></div>`;
            }
        }

        // initial dashboard load + interval
        loadDashboard();
        dashboardInterval = setInterval(loadDashboard, 2000);

        // keep live feed paused until user starts it
    </script>
</body>
</html>
